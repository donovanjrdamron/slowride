{{ 'tshirt-bundle.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign collection = section.settings.collection
  assign bundle_size = section.settings.bundle_size | default: 3
  assign bundle_price = section.settings.bundle_price | default: '$75'
  assign bundle_price_cents = section.settings.bundle_price_cents | default: 7500
  assign per_item_cents = bundle_price_cents | divided_by: bundle_size
-%}

<div
  class="tshirt-bundle color-{{ section.settings.color_scheme }}"
  id="TshirtBundle-{{ section.id }}"
  data-bundle-size="{{ bundle_size }}"
  data-bundle-price="{{ bundle_price }}"
  data-bundle-price-cents="{{ bundle_price_cents }}"
  data-per-item-cents="{{ per_item_cents }}"
  style="--progress-start: {{ section.settings.progress_color_start | default: '#48bb78' }}; --progress-end: {{ section.settings.progress_color_end | default: '#38a169' }}; --accent-color: {{ section.settings.accent_color | default: '#e53e3e' }}; --button-color: {{ section.settings.button_color | default: '#111111' }}; --button-text-color: {{ section.settings.button_text_color | default: '#ffffff' }}; --badge-color: {{ section.settings.badge_color | default: '#e53e3e' }}; --step-inactive-color: {{ section.settings.step_inactive_color | default: '#e0e0e0' }}; --step-text-inactive-color: {{ section.settings.step_text_inactive_color | default: '#cccccc' }};"
>
  <!-- ==================== DESKTOP LAYOUT ==================== -->
  <div class="bundle-layout">

    <!-- LEFT SIDEBAR (sticky) -->
    <aside class="bundle-sidebar" id="BundleSidebar">
      <div class="bundle-sidebar__inner">
        <h1 class="bundle-sidebar__title">{{ section.settings.bundle_title | default: 'T-Shirt Bundle' }}</h1>
        <div class="bundle-sidebar__subtitle">
          {{ section.settings.bundle_subtitle | default: '<p>Buy 3 only $75 + FREE Shipping</p>' }}
        </div>

        <!-- Progress Steps -->
        {%- assign num_bars = bundle_size | minus: 1 -%}
        <div class="bundle-progress" id="BundleProgress" style="--num-bars: {{ num_bars }};">
          {%- for i in (1..bundle_size) -%}
            <div class="bundle-progress__step {% if i == 1 %}bundle-progress__step--first{% endif %}" data-step="{{ i }}">
              <span class="bundle-progress__number">
                {% if i < 10 %}0{{ i }}{% else %}{{ i }}{% endif %}
              </span>
            </div>
            {%- unless i == bundle_size -%}
              {%- assign bar_idx = i | minus: 1 -%}
              {%- if num_bars > 1 -%}
                {%- assign bar_divisor = num_bars | minus: 1 -%}
                {%- assign bar_pos = bar_idx | times: 100 | divided_by: bar_divisor -%}
              {%- else -%}
                {%- assign bar_pos = 0 -%}
              {%- endif -%}
              <div class="bundle-progress__bar">
                <div class="bundle-progress__bar-fill" data-bar="{{ i }}" style="background-position: {{ bar_pos }}% 0;"></div>
              </div>
            {%- endunless -%}
          {%- endfor -%}
        </div>

        <!-- Counter + Price -->
        <div class="bundle-counter">
          <span class="bundle-counter__text">
            <span id="BundleCount">0</span> of {{ bundle_size }} selected
          </span>
          <span class="bundle-counter__price">{{ bundle_price }}</span>
        </div>

        <!-- Selection Slots -->
        <div class="bundle-slots" id="BundleSlots">
          {%- for i in (1..bundle_size) -%}
            <div class="bundle-slot" data-slot="{{ i }}">
              <div class="bundle-slot__empty">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              </div>
              <div class="bundle-slot__filled" style="display:none;">
                <div class="bundle-slot__image-wrap">
                  <img class="bundle-slot__image" src="" alt="" loading="lazy" width="80" height="80">
                  <button type="button" class="bundle-slot__remove" aria-label="Remove item" data-slot-index="{{ i }}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </button>
                </div>
                <div class="bundle-slot__info">
                  <span class="bundle-slot__name"></span>
                  <span class="bundle-slot__price"></span>
                </div>
              </div>
            </div>
          {%- endfor -%}
        </div>

        <!-- Total -->
        <div class="bundle-total">
          <span class="bundle-total__label">TOTAL</span>
          <div class="bundle-total__prices">
            <span class="bundle-total__amount" id="BundleTotal">$0.00</span>
            <s class="bundle-total__compare" id="BundleTotalCompare"></s>
          </div>
        </div>

        <!-- CTA Button -->
        <button
          type="button"
          class="bundle-cta"
          id="BundleCTA"
          disabled
        >
          Add {{ bundle_size }} more
        </button>
      </div>
    </aside>

    <!-- RIGHT: PRODUCT GRID -->
    <div class="bundle-products">
      {%- if collection != blank and collection.products.size > 0 -%}
        <div class="bundle-grid">
          {%- for product in collection.products -%}
            {%- assign variant = product.selected_or_first_available_variant -%}
            {%- assign product_image = product.featured_image -%}
            <div
              class="bundle-card"
              data-product-id="{{ product.id }}"
              data-variant-id="{{ variant.id }}"
              data-product-title="{{ product.title | escape }}"
              data-product-image="{{ product_image | image_url: width: 600 }}"
              data-product-thumb="{{ product_image | image_url: width: 200 }}"
              data-product-price="{{ variant.price }}"
              data-compare-price="{{ variant.compare_at_price }}"
              data-variant-count="{{ product.variants.size }}"
              data-product-options='{{ product.options | json }}'
              data-product-variants='{% for v in product.variants %}{"id":{{ v.id }},"title":{{ v.title | json }},"option1":{{ v.option1 | json }},"option2":{{ v.option2 | json }},"option3":{{ v.option3 | json }},"available":{{ v.available }},"price":{{ v.price }},"compare_at_price":{{ v.compare_at_price | default: 0 }},"image":"{{ v.featured_image | image_url: width: 600 | default: '' }}","thumb":"{{ v.featured_image | image_url: width: 200 | default: '' }}"}{% unless forloop.last %},{% endunless %}{% endfor %}'
            >
              <!-- Badge -->
              {%- if product.tags contains 'new' -%}
                <span class="bundle-card__badge">NEW</span>
              {%- endif -%}

              <!-- Image -->
              <div class="bundle-card__image-wrap">
                {%- if product_image != blank -%}
                  <img
                    class="bundle-card__image"
                    src="{{ product_image | image_url: width: 600 }}"
                    alt="{{ product_image.alt | escape }}"
                    loading="lazy"
                    width="600"
                    height="{{ 600 | divided_by: product_image.aspect_ratio | round }}"
                  >
                {%- else -%}
                  <div class="bundle-card__placeholder">
                    {{ 'product-1' | placeholder_svg_tag }}
                  </div>
                {%- endif -%}
              </div>

              <!-- Info -->
              <div class="bundle-card__info">
                <h3 class="bundle-card__title">
                  <a href="{{ product.url }}" class="bundle-card__title-link">{{ product.title }}</a>
                </h3>
                <div class="bundle-card__prices">
                  <span class="bundle-card__price">{{ variant.price | money }}</span>
                </div>
              </div>

              <!-- Add to Bundle Controls -->
              <div class="bundle-card__actions">
                <div class="bundle-card__qty-wrap" style="display:none;">
                  <button type="button" class="bundle-card__qty-btn bundle-card__qty-minus" aria-label="Decrease quantity">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                  </button>
                  <span class="bundle-card__qty-value">1</span>
                  <button type="button" class="bundle-card__qty-btn bundle-card__qty-add" aria-label="Add">Add</button>
                </div>
                <button type="button" class="bundle-card__add-btn">
                  Add to Bundle
                </button>
              </div>
            </div>
          {%- endfor -%}
        </div>
      {%- else -%}
        <div class="bundle-empty">
          <p>No products found. Please select a collection in the theme editor.</p>
        </div>
      {%- endif -%}
    </div>
  </div>

  <!-- ==================== VARIANT PICKER MODAL ==================== -->
  <div class="bundle-variant-modal" id="BundleVariantModal" aria-hidden="true">
    <div class="bundle-variant-modal__backdrop" id="BundleVariantBackdrop"></div>
    <div class="bundle-variant-modal__dialog" role="dialog" aria-modal="true">
      <button type="button" class="bundle-variant-modal__close" id="BundleVariantClose" aria-label="Close">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
      <div class="bundle-variant-modal__image-wrap">
        <img class="bundle-variant-modal__image" id="BundleVariantImage" src="" alt="" width="400" height="400">
      </div>
      <div class="bundle-variant-modal__body">
        <h3 class="bundle-variant-modal__title" id="BundleVariantTitle"></h3>
        <div class="bundle-variant-modal__price" id="BundleVariantPrice"></div>
        <div class="bundle-variant-modal__options" id="BundleVariantOptions"></div>
        <div class="bundle-variant-modal__error" id="BundleVariantError" style="display:none;"></div>
        <button type="button" class="bundle-cta bundle-variant-modal__confirm" id="BundleVariantConfirm" disabled>
          Select options
        </button>
      </div>
    </div>
  </div>

  <!-- ==================== MOBILE BOTTOM BAR ==================== -->
  <div class="bundle-mobile-bar" id="BundleMobileBar">
    <!-- Header row: title + chevron toggle -->
    <button type="button" class="bundle-mobile-bar__toggle" id="BundleMobileToggle" aria-expanded="false">
      <div class="bundle-mobile-bar__header">
        <span class="bundle-mobile-bar__title">{{ section.settings.bundle_title | default: 'T-Shirt Bundle' }}</span>
        <svg class="bundle-mobile-bar__chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>
      </div>
    </button>

    <!-- Always-visible summary (shown in collapsed AND expanded state) -->
    <div class="bundle-mobile-bar__summary">
      <div class="bundle-mobile-bar__subtitle">
        {{ section.settings.bundle_subtitle | default: '<p>Buy 3 only $75 + FREE Shipping</p>' }}
      </div>

      <!-- Mobile Progress -->
      <div class="bundle-progress bundle-progress--mobile" id="BundleProgressMobile" style="--num-bars: {{ num_bars }};">
        {%- for i in (1..bundle_size) -%}
          <div class="bundle-progress__step {% if i == 1 %}bundle-progress__step--first{% endif %}" data-step="{{ i }}">
            <span class="bundle-progress__number">
              {% if i < 10 %}0{{ i }}{% else %}{{ i }}{% endif %}
            </span>
          </div>
          {%- unless i == bundle_size -%}
            {%- assign bar_idx = i | minus: 1 -%}
            {%- if num_bars > 1 -%}
              {%- assign bar_divisor = num_bars | minus: 1 -%}
              {%- assign bar_pos = bar_idx | times: 100 | divided_by: bar_divisor -%}
            {%- else -%}
              {%- assign bar_pos = 0 -%}
            {%- endif -%}
            <div class="bundle-progress__bar">
              <div class="bundle-progress__bar-fill" data-bar="{{ i }}" style="background-position: {{ bar_pos }}% 0;"></div>
            </div>
          {%- endunless -%}
        {%- endfor -%}
      </div>

      <!-- Mobile Counter -->
      <div class="bundle-counter">
        <span class="bundle-counter__text">
          <span class="bundle-count-mobile">0</span> of {{ bundle_size }} selected
        </span>
        <span class="bundle-counter__price">{{ bundle_price }}</span>
      </div>

      <!-- Mobile Total -->
      <div class="bundle-total">
        <span class="bundle-total__label">TOTAL</span>
        <div class="bundle-total__prices">
          <span class="bundle-total__amount bundle-total-mobile">$0.00</span>
          <s class="bundle-total__compare bundle-total-compare-mobile"></s>
        </div>
      </div>

      <!-- Mobile CTA -->
      <button
        type="button"
        class="bundle-cta bundle-cta--mobile"
        id="BundleCTAMobile"
        disabled
      >
        Add {{ bundle_size }} more
      </button>
    </div>

    <!-- Expandable area: selection slots with thumbnails (only visible when expanded) -->
    <div class="bundle-mobile-bar__expandable" id="BundleMobileExpandable">
      <div class="bundle-mobile-slots" id="BundleMobileSlots">
        {%- for i in (1..bundle_size) -%}
          <div class="bundle-slot" data-slot="{{ i }}">
            <div class="bundle-slot__empty">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </div>
            <div class="bundle-slot__filled" style="display:none;">
              <div class="bundle-slot__image-wrap">
                <img class="bundle-slot__image" src="" alt="" loading="lazy" width="80" height="80">
                <button type="button" class="bundle-slot__remove" aria-label="Remove item" data-slot-index="{{ i }}">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
              </div>
              <div class="bundle-slot__info">
                <span class="bundle-slot__name"></span>
                <span class="bundle-slot__price"></span>
              </div>
            </div>
          </div>
        {%- endfor -%}
      </div>
    </div>
  </div>
</div>

<script src="{{ 'tshirt-bundle.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "T-Shirt Bundle",
  "class": "section-tshirt-bundle",
  "settings": [
    {
      "type": "text",
      "id": "bundle_title",
      "label": "Bundle Title",
      "default": "T-Shirt Bundle"
    },
    {
      "type": "richtext",
      "id": "bundle_subtitle",
      "label": "Bundle Subtitle",
      "default": "<p>Buy 3 only $75 + FREE Shipping</p>"
    },
    {
      "type": "range",
      "id": "bundle_size",
      "label": "Bundle Size (number of items)",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 3
    },
    {
      "type": "text",
      "id": "bundle_price",
      "label": "Bundle Display Price",
      "default": "$75",
      "info": "The display price shown on the page (e.g. $75)"
    },
    {
      "type": "number",
      "id": "bundle_price_cents",
      "label": "Bundle Price (in cents)",
      "default": 7500,
      "info": "The bundle price in cents for per-item price calculations (e.g. 7500 = $75.00)"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "T-Shirt Collection"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "progress_color_start",
      "label": "Progress Bar Gradient Start",
      "default": "#48bb78"
    },
    {
      "type": "color",
      "id": "progress_color_end",
      "label": "Progress Bar Gradient End",
      "default": "#38a169"
    },
    {
      "type": "color",
      "id": "step_inactive_color",
      "label": "Progress Step Inactive Border",
      "default": "#e0e0e0"
    },
    {
      "type": "color",
      "id": "step_text_inactive_color",
      "label": "Progress Step Inactive Text",
      "default": "#cccccc"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent Color (subtitle, compare prices)",
      "default": "#e53e3e"
    },
    {
      "type": "color",
      "id": "badge_color",
      "label": "NEW Badge Background",
      "default": "#e53e3e"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Color",
      "default": "#111111",
      "info": "Used for CTA button, card buttons, and borders"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    }
  ],
  "presets": [
    {
      "name": "T-Shirt Bundle"
    }
  ]
}
{% endschema %}
