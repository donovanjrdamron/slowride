
{% assign plain_text = block.settings.text | strip_newlines | strip_html | strip %}
{%- assign block_index = section.blocks | find_index: 'id', block.id -%}
{%- assign is_marquee_mode = false -%}
{%- if section.settings.display_mode == 'marquee' -%}
  {%- assign is_marquee_mode = true -%}
{%- endif -%}

{%- unless plain_text == '' -%}
  {%- if is_marquee_mode -%}
    {%- comment -%} ===== MARQUEE MODE: Render as inline ticker item ===== {%- endcomment -%}
    <span
      class="
        announcement-bar__marquee-item
        custom-typography
        {% if block.settings.font_size != '' %}custom-font-size{% endif %}
        {% if block.settings.weight != '' %}custom-font-weight{% endif %}
      "
      style="{% render 'typography-style', settings: block.settings, preset: 'custom' %} --line-height: 1;"
      {{ block.shopify_attributes }}
    >
      {%- if block.settings.link != blank -%}
        <a class="announcement-bar__marquee-link" href="{{ block.settings.link }}">
      {%- endif -%}

      <span class="announcement-bar__text-inner">
        {{- block.settings.text -}}
        {%- if block.settings.show_scribble -%}
          <svg class="announcement-bar__scribble announcement-bar__scribble--marquee" viewBox="0 0 200 14" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M0,7 C8,1 16,13 28,7 C40,1 48,13 60,7 C72,1 80,13 92,7 C104,1 112,13 124,7 C136,1 144,13 156,7 C168,1 176,13 188,7 C196,1 200,7 200,7" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" pathLength="100"/>
          </svg>
        {%- endif -%}
      </span>

      {%- if block.settings.link != blank -%}
        </a>
      {%- endif -%}

      {%- if block.settings.separator_icon != 'none' -%}
        <span class="announcement-bar__separator" aria-hidden="true">
          {%- if block.settings.separator_icon == 'custom' and block.settings.custom_separator_image != blank -%}
            <img
              src="{{ block.settings.custom_separator_image | image_url: width: 48 }}"
              alt=""
              class="announcement-bar__custom-icon"
              loading="eager"
            >
          {%- else -%}
            {%- case block.settings.separator_icon -%}
              {%- when 'circle' -%}
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2"/></svg>
              {%- when 'dot' -%}
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="5" fill="currentColor"/></svg>
              {%- when 'diamond' -%}
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L22 12L12 22L2 12Z" stroke="currentColor" stroke-width="2"/></svg>
              {%- when 'star' -%}
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor"/></svg>
              {%- when 'slash' -%}
                <svg viewBox="0 0 12 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 2L2 22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            {%- endcase -%}
          {%- endif -%}
        </span>
      {%- endif -%}
    </span>

  {%- else -%}
    {%- comment -%} ===== STATIC MODE: Render as slideshow slide ===== {%- endcomment -%}
    <slideshow-slide
      ref="slides[]"
      class="
        announcement-bar__slide
        text-block
        text-block--{{ block.id }}
        text-block--align-center
        text-block--full-width
        custom-typography
        {% if block.settings.font_size != "" %}custom-font-size{% endif %}
        {% if block.settings.weight != "" %}custom-font-weight{% endif %}
      "
      style="
        {% render 'typography-style', settings: block.settings, preset: 'custom' %}
        --width: 100%;
        --text-align: center;
        --line-height: 1;
      "
      {{ block.shopify_attributes }}
      aria-hidden="{% if block_index == 0 %}false{% else %}true{% endif %}"
    >
      <p class="announcement-bar__text">
        <span class="announcement-bar__text-inner">
          {{ block.settings.text }}
          {%- if block.settings.show_scribble -%}
            <svg class="announcement-bar__scribble" viewBox="0 0 200 14" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M0,7 C8,1 16,13 28,7 C40,1 48,13 60,7 C72,1 80,13 92,7 C104,1 112,13 124,7 C136,1 144,13 156,7 C168,1 176,13 188,7 C196,1 200,7 200,7" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" pathLength="100"/>
            </svg>
          {%- endif -%}
        </span>
      </p>

      {% if block.settings.link != blank %}
        <a
          class="announcement-bar__link"
          href="{{ block.settings.link }}"
        >
          <span class="visually-hidden">
            {{ block.settings.text | strip_html }}
          </span>
        </a>
      {% endif %}
    </slideshow-slide>
  {%- endif -%}
{%- endunless -%}

{% stylesheet %}
  /* Scribble underline animation */
  .announcement-bar__text-inner {
    position: relative;
    display: inline-block;
  }

  .announcement-bar__scribble {
    position: absolute;
    bottom: -5px;
    left: -2%;
    width: 104%;
    height: 10px;
    overflow: visible;
    opacity: 0.9;
    stroke-dasharray: 100;
    stroke-dashoffset: 100;
    animation: scribble-draw 1.4s cubic-bezier(0.65, 0, 0.35, 1) 0.3s forwards,
               scribble-pulse 3s ease-in-out 1.7s infinite;
  }

  /* In marquee mode, scribble is always fully drawn (no draw-in animation) */
  .announcement-bar__scribble--marquee {
    stroke-dashoffset: 0;
    animation: scribble-pulse 3s ease-in-out infinite;
  }

  @keyframes scribble-draw {
    0% {
      stroke-dashoffset: 100;
      opacity: 0;
    }
    10% {
      opacity: 0.9;
    }
    100% {
      stroke-dashoffset: 0;
      opacity: 0.9;
    }
  }

  @keyframes scribble-pulse {
    0%, 100% {
      opacity: 0.9;
      transform: scaleY(1);
    }
    50% {
      opacity: 0.6;
      transform: scaleY(0.85);
    }
  }

  /* Redraw animation on hover (static mode only) */
  .announcement-bar__slide:hover .announcement-bar__scribble {
    animation: scribble-redraw 0.6s cubic-bezier(0.65, 0, 0.35, 1) forwards;
  }

  @keyframes scribble-redraw {
    0% {
      stroke-dashoffset: 100;
    }
    100% {
      stroke-dashoffset: 0;
    }
  }

  /* Marquee item styles */
  .announcement-bar__marquee-item {
    display: inline-flex;
    align-items: center;
    white-space: nowrap;
    padding-inline: 0.5em;
    position: relative;
  }

  .announcement-bar__marquee-link {
    color: inherit;
    text-decoration: none;
  }

  .announcement-bar__separator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-inline-start: 1.5em;
    flex-shrink: 0;
  }

  .announcement-bar__separator svg {
    width: 1em;
    height: 1em;
    display: block;
  }

  .announcement-bar__custom-icon {
    width: 1em;
    height: 1em;
    display: block;
    object-fit: contain;
  }

  /* Text block styles */
  .text-block {
    width: var(--width);
    max-width: 100%;
  }

  .text-block > * {
    width: var(--width);
    max-width: var(--max-width, 100%);
    text-align: var(--text-align);
  }

  .text-block:not(.text-block--full-width).rte,
  .text-block:not(.text-block--full-width).paragraph {
    text-wrap: balance;
    text-wrap: pretty;
  }

  .text-block:not(.text-block--full-width).h1,
  .text-block:not(.text-block--full-width).h2,
  .text-block:not(.text-block--full-width).h3,
  .text-block:not(.text-block--full-width).h4,
  .text-block:not(.text-block--full-width).h5,
  .text-block:not(.text-block--full-width).h6 {
    text-wrap: balance;
  }

  .text-block:is(.h1, .h2, .h3, .h4, .h5, .h6) a {
    text-decoration-color: transparent;
  }

  .text-block h1,
  .text-block.h1 > * {
    margin-block: var(--font-h1--spacing);
  }

  .text-block h2,
  .text-block.h2 > * {
    margin-block: var(--font-h2--spacing);
  }

  .text-block h3,
  .text-block.h3 > * {
    margin-block: var(--font-h3--spacing);
  }

  .text-block h4,
  .text-block.h4 > * {
    margin-block: var(--font-h4--spacing);
  }

  .text-block h5,
  .text-block.h5 > * {
    margin-block: var(--font-h5--spacing);
  }

  .text-block h6,
  .text-block.h6 > * {
    margin-block: var(--font-h6--spacing);
  }

  .text-block > *:first-child {
    margin-block-start: 0;
  }

  .text-block > *:last-child {
    margin-block-end: 0;
  }

  .text-block--align-center,
  .text-block--align-center > * {
    margin-inline: auto;
  }

  .text-block--align-right,
  .text-block--align-right > * {
    margin-inline-start: auto;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.announcement",
  "tag": null,
  "settings": [
    {
      "type": "inline_richtext",
      "id": "text",
      "label": "t:settings.text",
      "default": "t:text_defaults.shop_our_latest_arrivals"
    },
    {
      "type": "url",
      "id": "link",
      "label": "t:settings.link"
    },
    {
      "type": "header",
      "content": "Scribble & separator"
    },
    {
      "type": "checkbox",
      "id": "show_scribble",
      "label": "Show scribble underline",
      "default": true
    },
    {
      "type": "select",
      "id": "separator_icon",
      "label": "Separator icon (marquee mode)",
      "info": "Icon shown between text repetitions in scrolling mode",
      "options": [
        {
          "value": "circle",
          "label": "Circle (ring)"
        },
        {
          "value": "dot",
          "label": "Dot (filled)"
        },
        {
          "value": "diamond",
          "label": "Diamond"
        },
        {
          "value": "star",
          "label": "Star"
        },
        {
          "value": "slash",
          "label": "Slash"
        },
        {
          "value": "custom",
          "label": "Custom image"
        },
        {
          "value": "none",
          "label": "None"
        }
      ],
      "default": "circle"
    },
    {
      "type": "image_picker",
      "id": "custom_separator_image",
      "label": "Custom separator image",
      "info": "Upload an SVG or small icon. Used when separator is set to 'Custom image'."
    },
    {
      "type": "header",
      "content": "t:content.typography"
    },
    {
      "type": "select",
      "id": "font",
      "label": "t:settings.font",
      "options": [
        {
          "value": "var(--font-body--family)",
          "label": "t:options.body"
        },
        {
          "value": "var(--font-subheading--family)",
          "label": "t:options.subheading"
        },
        {
          "value": "var(--font-heading--family)",
          "label": "t:options.heading"
        },
        {
          "value": "var(--font-accent--family)",
          "label": "t:options.accent"
        }
      ],
      "default": "var(--font-body--family)"
    },
    {
      "type": "select",
      "id": "font_size",
      "label": "t:settings.size",
      "options": [
        {
          "value": "",
          "label": "t:options.default"
        },
        {
          "value": "0.625rem",
          "label": "10px"
        },
        {
          "value": "0.75rem",
          "label": "12px"
        },
        {
          "value": "0.875rem",
          "label": "14px"
        },
        {
          "value": "1rem",
          "label": "16px"
        },
        {
          "value": "1.125rem",
          "label": "18px"
        },
        {
          "value": "1.25rem",
          "label": "20px"
        },
        {
          "value": "1.5rem",
          "label": "24px"
        },
        {
          "value": "2rem",
          "label": "32px"
        },
        {
          "value": "2.5rem",
          "label": "40px"
        },
        {
          "value": "3rem",
          "label": "48px"
        },
        {
          "value": "3.5rem",
          "label": "56px"
        },
        {
          "value": "4.5rem",
          "label": "72px"
        },
        {
          "value": "5.5rem",
          "label": "88px"
        },
        {
          "value": "7.5rem",
          "label": "120px"
        },
        {
          "value": "9.5rem",
          "label": "152px"
        },
        {
          "value": "11.5rem",
          "label": "184px"
        }
      ],
      "default": "1rem"
    },
    {
      "type": "select",
      "id": "weight",
      "label": "t:settings.weight",
      "options": [
        {
          "value": "",
          "label": "t:options.default"
        },
        {
          "value": "100",
          "label": "t:options.thin"
        },
        {
          "value": "300",
          "label": "t:options.light"
        },
        {
          "value": "400",
          "label": "t:options.regular"
        },
        {
          "value": "500",
          "label": "t:options.medium"
        },
        {
          "value": "600",
          "label": "t:options.semibold"
        },
        {
          "value": "700",
          "label": "t:options.bold"
        },
        {
          "value": "900",
          "label": "t:options.black"
        }
      ],
      "default": ""
    },
    {
      "type": "select",
      "id": "letter_spacing",
      "label": "t:settings.letter_spacing",
      "options": [
        {
          "value": "tight",
          "label": "t:options.tight"
        },
        {
          "value": "normal",
          "label": "t:options.normal"
        },
        {
          "value": "loose",
          "label": "t:options.loose"
        }
      ],
      "default": "normal"
    },
    {
      "type": "select",
      "id": "case",
      "label": "t:settings.case",
      "options": [
        {
          "value": "none",
          "label": "t:options.default"
        },
        {
          "value": "uppercase",
          "label": "t:options.uppercase"
        }
      ],
      "default": "none"
    }
  ],
  "presets": [
    {
      "name": "t:names.announcement"
    }
  ]
}
{% endschema %}
